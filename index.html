<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1e3a5f">
  <meta name="description" content="Dam Safety Inspection App - Section 3 On-Site Inspection">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Dam Inspect">
  <title>Dam Safety Inspection</title>
  
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    html, body, #root { height: 100%; margin: 0; overflow: hidden; }
    .scroll-container { -webkit-overflow-scrolling: touch; }
    .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; }
    .photo-thumb { aspect-ratio: 1; object-fit: cover; border-radius: 8px; cursor: pointer; }
    textarea { resize: none; -webkit-appearance: none; -webkit-user-select: text; user-select: text; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;
    
    // SVG Icons
    const Save = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
    const Download = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
    const Upload = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
    const Mic = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></svg>;
    const MicOff = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="2" y1="2" x2="22" y2="22"/><path d="M18.89 13.23A7.12 7.12 0 0 0 19 12v-2"/><path d="M5 10v2a7 7 0 0 0 12 5"/><path d="M15 9.34V5a3 3 0 0 0-5.68-1.33"/><path d="M9 9v3a3 3 0 0 0 5.12 2.12"/><line x1="12" y1="19" x2="12" y2="22"/></svg>;
    const Camera = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>;
    const Sparkles = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3L12 3Z"/></svg>;
    const X = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
    const Menu = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/></svg>;
    const CheckCircle = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
    const AlertCircle = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>;
    const Wifi = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5 13a10 10 0 0 1 14 0"/><path d="M8.5 16.5a5 5 0 0 1 7 0"/><path d="M2 8.82a15 15 0 0 1 20 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>;
    const WifiOff = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="2" y1="2" x2="22" y2="22"/><path d="M8.5 16.5a5 5 0 0 1 7 0"/><path d="M2 8.82a15 15 0 0 1 4.17-2.65"/><path d="M10.66 5c4.01-.36 8.14.9 11.34 3.76"/><path d="M16.85 11.25a10 10 0 0 1 2.22 1.68"/><path d="M5 13a10 10 0 0 1 5.24-2.76"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>;
    const Eye = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>;
    const Activity = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>;
    const Trash = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
    const Plus = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
    const ChevronDown = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="6 9 12 15 18 9"/></svg>;
    const FolderOpen = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H18a2 2 0 0 1 2 2v2"/></svg>;

    // Storage helper
    const storage = {
      get: (key) => {
        try {
          const value = localStorage.getItem(key);
          return value ? { value } : null;
        } catch (e) { return null; }
      },
      set: (key, value) => {
        try {
          localStorage.setItem(key, value);
          return { key, value };
        } catch (e) { return null; }
      },
      remove: (key) => {
        try {
          localStorage.removeItem(key);
          return true;
        } catch (e) { return false; }
      }
    };

    // Word counter
    const countWords = (text) => {
      if (!text || !text.trim()) return 0;
      return text.trim().split(/\s+/).length;
    };

    // Empty inspection template
    const getEmptyInspection = () => ({
      general: { access: '', routineReports: '', emergencyWarning: '', illumination: '', waterLevel: '', weatherConditions: '' },
      crest: { condition: '', vegetation: '', animalActivity: '', settlement: '' },
      upstream: { slopeProtection: '', condition: '', vegetation: '', animalBurrows: '' },
      downstream: { slopeProtection: '', condition: '', vegetation: '', seepage: '', animalActivity: '' },
      toe: { condition: '', erosion: '', seepage: '', vegetation: '', drainageSystem: '', valleyFloor: '' },
      spillway: { description: '', condition: '', vegetation: '', erosion: '' },
      outlet: { description: '', operation: '', condition: '', access: '', maintenance: '', seepage: '' },
      basin: { condition: '', erosion: '', seepage: '' },
      monitoring: { description: '', settlementMonitoring: '', seepageMonitoring: '' },
      crestSurvey: [{ chainage: '0', level: '', freeboard: '', comment: 'Left Flank' }],
      photos: {}
    });

    const Section3Inspection = () => {
      // Project management state
      const [projects, setProjects] = useState([]);
      const [currentProjectId, setCurrentProjectId] = useState(null);
      const [showProjectModal, setShowProjectModal] = useState(false);
      const [showNewProjectModal, setShowNewProjectModal] = useState(false);
      const [newDamName, setNewDamName] = useState('');
      const [newInspectionDate, setNewInspectionDate] = useState(new Date().toISOString().split('T')[0]);
      
      const [activeTab, setActiveTab] = useState('general');
      const [status, setStatus] = useState('');
      const [loading, setLoading] = useState(true);
      const [isRecording, setIsRecording] = useState(false);
      const [currentField, setCurrentField] = useState(null);
      const [isOnline, setIsOnline] = useState(navigator.onLine);
      const [showMenu, setShowMenu] = useState(false);
      const [aiProcessing, setAiProcessing] = useState(null);
      const [photoViewer, setPhotoViewer] = useState(null);
      const recognitionRef = useRef(null);
      const importFileRef = useRef(null);
      const cameraInputRef = useRef(null);
      const [cameraTarget, setCameraTarget] = useState(null);
      
      const inspectionRef = useRef(getEmptyInspection());
      const [photos, setPhotos] = useState({});
      const [crestSurvey, setCrestSurvey] = useState([{ chainage: '0', level: '', freeboard: '', comment: 'Left Flank' }]);
      const [, forceUpdate] = useState(0);

      // Load projects on startup
      useEffect(() => {
        loadProjects();
        const handleOnline = () => setIsOnline(true);
        const handleOffline = () => setIsOnline(false);
        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);
        return () => {
          window.removeEventListener('online', handleOnline);
          window.removeEventListener('offline', handleOffline);
        };
      }, []);

      const loadProjects = () => {
        setLoading(true);
        try {
          const projectListResult = storage.get('dam-projects-list');
          if (projectListResult?.value) {
            const projectList = JSON.parse(projectListResult.value);
            setProjects(projectList);
            
            // Load last active project
            const lastActiveResult = storage.get('dam-last-active-project');
            if (lastActiveResult?.value) {
              const lastActiveId = lastActiveResult.value;
              const project = projectList.find(p => p.id === lastActiveId);
              if (project) {
                loadProject(lastActiveId);
              } else if (projectList.length > 0) {
                loadProject(projectList[0].id);
              }
            } else if (projectList.length > 0) {
              loadProject(projectList[0].id);
            }
          }
          setStatus('Ready');
        } catch (error) {
          console.error('Load error:', error);
          setStatus('Starting fresh');
        }
        setLoading(false);
        setTimeout(() => setStatus(''), 2000);
      };

      const loadProject = (projectId) => {
        try {
          const projectDataResult = storage.get(`dam-project-${projectId}`);
          if (projectDataResult?.value) {
            const data = JSON.parse(projectDataResult.value);
            inspectionRef.current = { ...getEmptyInspection(), ...data.inspection };
            setPhotos(data.inspection?.photos || {});
            setCrestSurvey(data.inspection?.crestSurvey || [{ chainage: '0', level: '', freeboard: '', comment: 'Left Flank' }]);
            setCurrentProjectId(projectId);
            storage.set('dam-last-active-project', projectId);
            forceUpdate(n => n + 1);
            setStatus(`âœ“ Loaded: ${data.damName}`);
            setTimeout(() => setStatus(''), 2000);
          }
        } catch (error) {
          console.error('Load project error:', error);
        }
      };

      const saveCurrentProject = () => {
        if (!currentProjectId) return;
        
        try {
          const project = projects.find(p => p.id === currentProjectId);
          if (!project) return;
          
          const dataToSave = {
            damName: project.damName,
            inspectionDate: project.inspectionDate,
            inspection: {
              ...inspectionRef.current,
              photos,
              crestSurvey
            },
            lastModified: new Date().toISOString()
          };
          
          storage.set(`dam-project-${currentProjectId}`, JSON.stringify(dataToSave));
          
          // Update project list with last modified
          const updatedProjects = projects.map(p => 
            p.id === currentProjectId ? { ...p, lastModified: dataToSave.lastModified } : p
          );
          setProjects(updatedProjects);
          storage.set('dam-projects-list', JSON.stringify(updatedProjects));
          
          setStatus('âœ“ Saved!');
          setTimeout(() => setStatus(''), 2000);
        } catch (error) {
          console.error('Save error:', error);
          setStatus('Error saving');
          setTimeout(() => setStatus(''), 2000);
        }
      };

      const createNewProject = () => {
        if (!newDamName.trim()) {
          setStatus('Please enter a dam name');
          setTimeout(() => setStatus(''), 2000);
          return;
        }
        
        // Save current project first
        if (currentProjectId) {
          saveCurrentProject();
        }
        
        const newProject = {
          id: `project-${Date.now()}`,
          damName: newDamName.trim(),
          inspectionDate: newInspectionDate,
          createdAt: new Date().toISOString(),
          lastModified: new Date().toISOString()
        };
        
        // Save new project data
        const newProjectData = {
          damName: newProject.damName,
          inspectionDate: newProject.inspectionDate,
          inspection: getEmptyInspection(),
          lastModified: newProject.lastModified
        };
        storage.set(`dam-project-${newProject.id}`, JSON.stringify(newProjectData));
        
        // Update projects list
        const updatedProjects = [...projects, newProject];
        setProjects(updatedProjects);
        storage.set('dam-projects-list', JSON.stringify(updatedProjects));
        
        // Load the new project
        inspectionRef.current = getEmptyInspection();
        setPhotos({});
        setCrestSurvey([{ chainage: '0', level: '', freeboard: '', comment: 'Left Flank' }]);
        setCurrentProjectId(newProject.id);
        storage.set('dam-last-active-project', newProject.id);
        
        // Reset form
        setNewDamName('');
        setNewInspectionDate(new Date().toISOString().split('T')[0]);
        setShowNewProjectModal(false);
        forceUpdate(n => n + 1);
        
        setStatus(`âœ“ Created: ${newProject.damName}`);
        setTimeout(() => setStatus(''), 2000);
      };

      const switchProject = (projectId) => {
        if (projectId === currentProjectId) {
          setShowProjectModal(false);
          return;
        }
        
        // Save current project first
        if (currentProjectId) {
          saveCurrentProject();
        }
        
        // Load selected project
        loadProject(projectId);
        setShowProjectModal(false);
      };

      const deleteProject = (projectId) => {
        const project = projects.find(p => p.id === projectId);
        if (!project) return;
        
        if (!confirm(`Delete inspection for "${project.damName}"?\n\nThis cannot be undone.`)) {
          return;
        }
        
        // Remove project data
        storage.remove(`dam-project-${projectId}`);
        
        // Update projects list
        const updatedProjects = projects.filter(p => p.id !== projectId);
        setProjects(updatedProjects);
        storage.set('dam-projects-list', JSON.stringify(updatedProjects));
        
        // If deleted current project, switch to another or clear
        if (projectId === currentProjectId) {
          if (updatedProjects.length > 0) {
            loadProject(updatedProjects[0].id);
          } else {
            setCurrentProjectId(null);
            inspectionRef.current = getEmptyInspection();
            setPhotos({});
            setCrestSurvey([{ chainage: '0', level: '', freeboard: '', comment: 'Left Flank' }]);
            forceUpdate(n => n + 1);
          }
        }
        
        setStatus('âœ“ Deleted');
        setTimeout(() => setStatus(''), 2000);
      };

      const getCurrentProject = () => {
        return projects.find(p => p.id === currentProjectId);
      };

      // AI Improve function
      const improveTextWithAI = async (section, field, text) => {
        if (!text || !text.trim() || text.trim().length < 10) return text;
        if (!navigator.onLine) return text;

        const fieldKey = `${section}_${field}`;
        setAiProcessing(fieldKey);
        setStatus('ðŸ¤– AI improving...');
        
        try {
          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 500,
              messages: [{
                role: "user",
                content: `Improve this dam inspection note for a professional report. Fix grammar, spelling, punctuation. Improve clarity and flow. Keep technical details accurate. Return ONLY the improved text:\n\n${text}`
              }]
            })
          });

          const data = await response.json();
          const improved = data.content?.filter(i => i.type === "text").map(i => i.text).join("") || text;
          setStatus('âœ“ AI improved!');
          setTimeout(() => setStatus(''), 2000);
          return improved.trim();
        } catch (error) {
          console.error('AI error:', error);
          setStatus('AI unavailable');
          setTimeout(() => setStatus(''), 2000);
          return text;
        } finally {
          setAiProcessing(null);
        }
      };

      // Photo handling
      const openCamera = (section, field) => {
        setCameraTarget({ section, field });
        cameraInputRef.current?.click();
      };

      const handlePhotoCapture = (e) => {
        const file = e.target.files[0];
        if (!file || !cameraTarget) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          const photoKey = `${cameraTarget.section}_${cameraTarget.field}`;
          const newPhoto = {
            id: Date.now(),
            data: event.target.result,
            timestamp: new Date().toISOString()
          };
          
          setPhotos(prev => ({
            ...prev,
            [photoKey]: [...(prev[photoKey] || []), newPhoto]
          }));
          setStatus('âœ“ Photo added!');
          setTimeout(() => setStatus(''), 2000);
        };
        reader.readAsDataURL(file);
        e.target.value = '';
        setCameraTarget(null);
      };

      const deletePhoto = (photoKey, photoId) => {
        setPhotos(prev => ({
          ...prev,
          [photoKey]: prev[photoKey].filter(p => p.id !== photoId)
        }));
        setPhotoViewer(null);
      };

      const getPhotos = (section, field) => {
        const photoKey = `${section}_${field}`;
        return photos[photoKey] || [];
      };

      // Voice recording
      const startRecording = (section, field) => {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognitionRef.current = new SpeechRecognition();
          recognitionRef.current.continuous = true;
          recognitionRef.current.interimResults = false;
          recognitionRef.current.lang = 'en-US';

          setCurrentField({ section, field });

          recognitionRef.current.onresult = (event) => {
            const result = event.results[event.results.length - 1];
            if (result.isFinal) {
              const transcript = result[0].transcript.trim();
              if (transcript) {
                const currentText = inspectionRef.current[section][field] || '';
                const separator = currentText && !currentText.endsWith(' ') ? ' ' : '';
                inspectionRef.current[section][field] = currentText + separator + transcript;
                forceUpdate(n => n + 1);
              }
            }
          };

          recognitionRef.current.onerror = (event) => {
            console.error('Speech error:', event.error);
            setIsRecording(false);
            setCurrentField(null);
          };

          try {
            recognitionRef.current.start();
            setIsRecording(true);
            setStatus('ðŸŽ¤ Recording...');
          } catch (e) {
            setStatus('Could not start recording');
            setTimeout(() => setStatus(''), 2000);
          }
        } else {
          alert('Voice not supported');
        }
      };

      const stopRecording = () => {
        setIsRecording(false);
        if (recognitionRef.current) {
          try { recognitionRef.current.stop(); } catch (e) {}
          recognitionRef.current = null;
        }
        setCurrentField(null);
        setStatus('');
      };

      // Survey points
      const addSurveyPoint = () => {
        setCrestSurvey(prev => [...prev, { chainage: '', level: '', freeboard: '', comment: '' }]);
      };

      const updateSurveyPoint = (index, field, value) => {
        setCrestSurvey(prev => {
          const updated = [...prev];
          updated[index] = { ...updated[index], [field]: value };
          
          if (field === 'level' && value) {
            try {
              const mainFeaturesResult = storage.get('dam-main-features');
              if (mainFeaturesResult?.value) {
                const mainFeatures = JSON.parse(mainFeaturesResult.value);
                const fsl = parseFloat(mainFeatures.fsl);
                if (!isNaN(fsl)) {
                  updated[index].freeboard = (parseFloat(value) - fsl).toFixed(2);
                }
              }
            } catch (error) {}
          }
          return updated;
        });
      };

      const removeSurveyPoint = (index) => {
        setCrestSurvey(prev => prev.filter((_, i) => i !== index));
      };

      // Export
      const exportData = () => {
        const project = getCurrentProject();
        const exportObj = { 
          damName: project?.damName || 'Unknown',
          inspectionDate: project?.inspectionDate || '',
          inspection: {
            ...inspectionRef.current,
            photos,
            crestSurvey
          },
          exportDate: new Date().toISOString() 
        };
        const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `DamInspection_${project?.damName || 'Draft'}_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        setStatus('âœ“ Exported!');
        setTimeout(() => setStatus(''), 2000);
      };

      const handleImport = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (data && data.inspection) {
              // Create new project from import
              const newProject = {
                id: `project-${Date.now()}`,
                damName: data.damName || 'Imported Dam',
                inspectionDate: data.inspectionDate || new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString()
              };
              
              const newProjectData = {
                damName: newProject.damName,
                inspectionDate: newProject.inspectionDate,
                inspection: data.inspection,
                lastModified: newProject.lastModified
              };
              storage.set(`dam-project-${newProject.id}`, JSON.stringify(newProjectData));
              
              const updatedProjects = [...projects, newProject];
              setProjects(updatedProjects);
              storage.set('dam-projects-list', JSON.stringify(updatedProjects));
              
              // Load imported project
              loadProject(newProject.id);
              setStatus(`âœ“ Imported: ${newProject.damName}`);
            }
          } catch (error) {
            setStatus('Invalid file');
          }
          setTimeout(() => setStatus(''), 2000);
        };
        reader.readAsText(file);
        e.target.value = '';
      };

      const generateReport = () => {
        const project = getCurrentProject();
        const photoCount = Object.values(photos).flat().length;
        const d = inspectionRef.current;
        const preview = `DAM SAFETY INSPECTION REPORT
Section 3: On-Site Inspection
Dam: ${project?.damName || 'Unknown'}
Inspection Date: ${project?.inspectionDate || ''}
Report Generated: ${new Date().toLocaleDateString()}
Photos: ${photoCount} attached
========================================

3.1 GENERAL
Access: ${d.general.access}
Routine Reports: ${d.general.routineReports}
Emergency Warning: ${d.general.emergencyWarning}
Illumination: ${d.general.illumination}
Water Level: ${d.general.waterLevel}
Weather: ${d.general.weatherConditions}

3.2 NON-OVERSPILL CREST
Condition: ${d.crest.condition}
Vegetation: ${d.crest.vegetation}
Animal Activity: ${d.crest.animalActivity}
Settlement: ${d.crest.settlement}

3.3 UPSTREAM FACE
Slope Protection: ${d.upstream.slopeProtection}
Condition: ${d.upstream.condition}
Vegetation: ${d.upstream.vegetation}
Animal Burrows: ${d.upstream.animalBurrows}

3.4 DOWNSTREAM FACE
Slope Protection: ${d.downstream.slopeProtection}
Condition: ${d.downstream.condition}
Vegetation: ${d.downstream.vegetation}
Seepage: ${d.downstream.seepage}
Animal Activity: ${d.downstream.animalActivity}

3.5 DOWNSTREAM TOE
Condition: ${d.toe.condition}
Erosion: ${d.toe.erosion}
Seepage: ${d.toe.seepage}
Vegetation: ${d.toe.vegetation}
Drainage: ${d.toe.drainageSystem}
Valley Floor: ${d.toe.valleyFloor}

3.6 SPILLWAY
Description: ${d.spillway.description}
Condition: ${d.spillway.condition}
Vegetation: ${d.spillway.vegetation}
Erosion: ${d.spillway.erosion}

3.7 OUTLET WORKS
Description: ${d.outlet.description}
Operation: ${d.outlet.operation}
Condition: ${d.outlet.condition}
Access: ${d.outlet.access}
Maintenance: ${d.outlet.maintenance}
Seepage: ${d.outlet.seepage}

3.8 RESERVOIR BASIN
Condition: ${d.basin.condition}
Erosion: ${d.basin.erosion}
Seepage: ${d.basin.seepage}

3.9 MONITORING
Description: ${d.monitoring.description}
Settlement: ${d.monitoring.settlementMonitoring}
Seepage: ${d.monitoring.seepageMonitoring}

3.9.1 CREST SURVEY
${crestSurvey.map(p => `Chainage ${p.chainage}m: RL ${p.level}m, Freeboard ${p.freeboard}m - ${p.comment}`).join('\n')}
`;
        const blob = new Blob([preview], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Report_${project?.damName || 'Draft'}_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        URL.revokeObjectURL(url);
      };

      const tabs = [
        { id: 'general', name: '3.1 General', icon: Eye },
        { id: 'crest', name: '3.2 Crest', icon: Eye },
        { id: 'upstream', name: '3.3 Upstream', icon: Eye },
        { id: 'downstream', name: '3.4 Downstream', icon: Eye },
        { id: 'toe', name: '3.5 Toe', icon: Eye },
        { id: 'spillway', name: '3.6 Spillway', icon: Eye },
        { id: 'outlet', name: '3.7 Outlet', icon: Eye },
        { id: 'basin', name: '3.8 Basin', icon: Eye },
        { id: 'monitoring', name: '3.9 Monitoring', icon: Activity },
        { id: 'survey', name: '3.9.1 Survey', icon: Activity }
      ];

      // Native textarea component
      const NativeTextArea = ({ section, field, rows, placeholder, onAiImprove }) => {
        const textareaRef = useRef(null);
        const initialValueRef = useRef('');
        const [wordCount, setWordCount] = useState(0);
        
        useEffect(() => {
          if (textareaRef.current) {
            const value = inspectionRef.current[section]?.[field] || '';
            textareaRef.current.value = value;
            initialValueRef.current = value;
            setWordCount(countWords(value));
          }
        }, [section, field, currentProjectId]);
        
        const handleInput = (e) => {
          const value = e.target.value;
          const words = countWords(value);
          
          if (words > 1000) {
            const trimmed = value.split(/\s+/).slice(0, 1000).join(' ');
            e.target.value = trimmed;
            inspectionRef.current[section][field] = trimmed;
            setWordCount(1000);
          } else {
            inspectionRef.current[section][field] = value;
            setWordCount(words);
          }
        };
        
        const handleBlur = async () => {
          const currentValue = textareaRef.current?.value || '';
          const hasChanged = currentValue !== initialValueRef.current;
          
          if (hasChanged && currentValue.trim().length >= 20 && navigator.onLine) {
            const improved = await onAiImprove(section, field, currentValue);
            if (improved && improved !== currentValue && textareaRef.current) {
              textareaRef.current.value = improved;
              inspectionRef.current[section][field] = improved;
              initialValueRef.current = improved;
              setWordCount(countWords(improved));
            }
          }
        };
        
        return (
          <div>
            <textarea
              ref={textareaRef}
              rows={rows}
              placeholder={placeholder}
              onInput={handleInput}
              onBlur={handleBlur}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none"
              style={{ fontSize: '16px' }}
            />
            <div className={`text-xs mt-1 text-right ${wordCount >= 1000 ? 'text-red-500' : 'text-gray-400'}`}>
              {wordCount} / 1000 words
            </div>
          </div>
        );
      };

      // Inspection Field Component
      const InspectionField = ({ label, section, field, rows = 3 }) => {
        const fieldPhotos = getPhotos(section, field);
        const isAiProcessing = aiProcessing === `${section}_${field}`;
        const isCurrentRecording = isRecording && currentField?.section === section && currentField?.field === field;

        return (
          <div className="mb-5 bg-gray-50 rounded-lg p-3">
            <div className="flex justify-between items-center mb-2">
              <label className="text-sm font-semibold text-gray-700">{label}</label>
              <div className="flex gap-1">
                <button
                  onClick={() => openCamera(section, field)}
                  className="p-2 bg-blue-600 text-white rounded-lg"
                  type="button"
                >
                  <Camera className="w-4 h-4" />
                </button>
                
                <button
                  onClick={() => isCurrentRecording ? stopRecording() : startRecording(section, field)}
                  className={`p-2 rounded-lg ${isCurrentRecording ? 'bg-red-600 animate-pulse' : 'bg-green-600'} text-white`}
                  type="button"
                >
                  {isCurrentRecording ? <MicOff className="w-4 h-4" /> : <Mic className="w-4 h-4" />}
                </button>
                
                {isAiProcessing && (
                  <div className="p-2 bg-purple-500 text-white rounded-lg">
                    <Sparkles className="w-4 h-4 animate-spin" />
                  </div>
                )}
              </div>
            </div>
            
            <NativeTextArea
              section={section}
              field={field}
              rows={rows}
              placeholder={`Enter ${label.toLowerCase()} observations...`}
              onAiImprove={improveTextWithAI}
            />
            
            {fieldPhotos.length > 0 && (
              <div className="mt-2">
                <p className="text-xs text-gray-500 mb-1">{fieldPhotos.length} photo(s)</p>
                <div className="photo-grid">
                  {fieldPhotos.map((photo) => (
                    <img
                      key={photo.id}
                      src={photo.data}
                      alt="Inspection"
                      className="photo-thumb border-2 border-gray-200"
                      onClick={() => setPhotoViewer({ photoKey: `${section}_${field}`, photo })}
                    />
                  ))}
                </div>
              </div>
            )}
          </div>
        );
      };

      if (loading) {
        return (
          <div className="min-h-screen bg-gray-100 flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-900 mx-auto mb-4"></div>
              <p className="text-gray-600">Loading...</p>
            </div>
          </div>
        );
      }

      const currentProject = getCurrentProject();

      return (
        <div className="h-screen flex flex-col bg-gray-100">
          {/* Hidden inputs */}
          <input
            ref={cameraInputRef}
            type="file"
            accept="image/*"
            capture="environment"
            onChange={handlePhotoCapture}
            className="hidden"
          />
          <input ref={importFileRef} type="file" accept=".json" onChange={handleImport} className="hidden" />

          {/* Offline Banner */}
          {!isOnline && (
            <div className="bg-amber-500 text-white text-center py-1 text-xs flex items-center justify-center gap-1">
              <WifiOff className="w-3 h-3" /> Offline - Auto AI disabled
            </div>
          )}
          
          {/* Header with Project Selector */}
          <div className="bg-blue-900 text-white flex-shrink-0">
            {/* Top row */}
            <div className="p-3 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <button onClick={() => setShowMenu(!showMenu)} className="p-1" type="button">
                  <Menu className="w-6 h-6" />
                </button>
                <div>
                  <h1 className="text-lg font-bold leading-tight">Dam Inspection</h1>
                </div>
              </div>
              <div className="flex items-center gap-2">
                {isOnline ? <Wifi className="w-4 h-4 text-green-300" /> : <WifiOff className="w-4 h-4 text-amber-300" />}
              </div>
            </div>
            
            {/* Project selector row */}
            <div className="px-3 pb-3 flex gap-2">
              <button
                onClick={() => setShowProjectModal(true)}
                className="flex-1 bg-blue-800 hover:bg-blue-700 rounded-lg px-3 py-2 flex items-center justify-between"
                type="button"
              >
                <div className="flex items-center gap-2 text-left">
                  <FolderOpen className="w-4 h-4" />
                  <div>
                    <div className="text-sm font-medium truncate" style={{maxWidth: '180px'}}>
                      {currentProject?.damName || 'No project selected'}
                    </div>
                    {currentProject?.inspectionDate && (
                      <div className="text-xs text-blue-300">{currentProject.inspectionDate}</div>
                    )}
                  </div>
                </div>
                <ChevronDown className="w-4 h-4" />
              </button>
              
              <button
                onClick={() => setShowNewProjectModal(true)}
                className="bg-green-600 hover:bg-green-500 rounded-lg px-3 py-2 flex items-center gap-1"
                type="button"
              >
                <Plus className="w-4 h-4" />
                <span className="text-sm">New</span>
              </button>
            </div>
          </div>

          {/* Status */}
          {status && (
            <div className={`px-3 py-2 text-sm flex items-center gap-2 ${status.includes('âœ“') ? 'bg-green-100 text-green-800' : status.includes('ðŸŽ¤') ? 'bg-red-100 text-red-800' : status.includes('ðŸ¤–') ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}`}>
              {status.includes('âœ“') ? <CheckCircle className="w-4 h-4" /> : <AlertCircle className="w-4 h-4" />}
              {status}
            </div>
          )}

          {/* Project Selection Modal */}
          {showProjectModal && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
              <div className="absolute inset-0 bg-black bg-opacity-50" onClick={() => setShowProjectModal(false)}></div>
              <div className="relative bg-white rounded-xl w-full max-w-md max-h-[80vh] overflow-hidden">
                <div className="bg-blue-900 text-white p-4 flex justify-between items-center">
                  <h2 className="font-bold">Select Inspection</h2>
                  <button onClick={() => setShowProjectModal(false)} type="button"><X className="w-5 h-5" /></button>
                </div>
                
                <div className="overflow-y-auto max-h-[60vh]">
                  {projects.length === 0 ? (
                    <div className="p-6 text-center text-gray-500">
                      <FolderOpen className="w-12 h-12 mx-auto mb-2 opacity-50" />
                      <p>No inspections yet</p>
                      <p className="text-sm">Tap "New" to create one</p>
                    </div>
                  ) : (
                    projects.map(project => (
                      <div 
                        key={project.id}
                        className={`p-4 border-b flex items-center justify-between ${project.id === currentProjectId ? 'bg-blue-50' : ''}`}
                      >
                        <button
                          onClick={() => switchProject(project.id)}
                          className="flex-1 text-left"
                          type="button"
                        >
                          <div className="font-medium">{project.damName}</div>
                          <div className="text-xs text-gray-500">
                            {project.inspectionDate} â€¢ Modified: {new Date(project.lastModified).toLocaleDateString()}
                          </div>
                        </button>
                        <button
                          onClick={() => deleteProject(project.id)}
                          className="p-2 text-red-600 hover:bg-red-50 rounded"
                          type="button"
                        >
                          <Trash className="w-4 h-4" />
                        </button>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>
          )}

          {/* New Project Modal */}
          {showNewProjectModal && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
              <div className="absolute inset-0 bg-black bg-opacity-50" onClick={() => setShowNewProjectModal(false)}></div>
              <div className="relative bg-white rounded-xl w-full max-w-md overflow-hidden">
                <div className="bg-green-600 text-white p-4 flex justify-between items-center">
                  <h2 className="font-bold">New Inspection</h2>
                  <button onClick={() => setShowNewProjectModal(false)} type="button"><X className="w-5 h-5" /></button>
                </div>
                
                <div className="p-4">
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Dam Name *</label>
                    <input
                      type="text"
                      value={newDamName}
                      onChange={(e) => setNewDamName(e.target.value)}
                      placeholder="Enter dam name"
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"
                      style={{ fontSize: '16px' }}
                    />
                  </div>
                  
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-1">Inspection Date</label>
                    <input
                      type="date"
                      value={newInspectionDate}
                      onChange={(e) => setNewInspectionDate(e.target.value)}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"
                      style={{ fontSize: '16px' }}
                    />
                  </div>
                  
                  <button
                    onClick={createNewProject}
                    className="w-full py-3 bg-green-600 text-white rounded-lg font-medium"
                    type="button"
                  >
                    Create Inspection
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Side Menu */}
          {showMenu && (
            <div className="fixed inset-0 z-50 flex">
              <div className="absolute inset-0 bg-black bg-opacity-50" onClick={() => setShowMenu(false)}></div>
              <div className="relative bg-white w-72 h-full shadow-xl overflow-y-auto">
                <div className="bg-blue-900 text-white p-4 flex justify-between items-center">
                  <h2 className="font-bold">Menu</h2>
                  <button onClick={() => setShowMenu(false)} type="button"><X className="w-5 h-5" /></button>
                </div>
                
                <div className="p-3">
                  <p className="text-xs font-semibold text-gray-500 uppercase mb-2">Sections</p>
                  {tabs.map(tab => (
                    <button
                      key={tab.id}
                      onClick={() => { setActiveTab(tab.id); setShowMenu(false); }}
                      className={`w-full text-left px-3 py-2 rounded text-sm mb-1 ${activeTab === tab.id ? 'bg-blue-100 text-blue-900 font-medium' : 'hover:bg-gray-100'}`}
                      type="button"
                    >
                      {tab.name}
                    </button>
                  ))}
                </div>
                
                <div className="border-t p-3">
                  <p className="text-xs font-semibold text-gray-500 uppercase mb-2">Actions</p>
                  <button onClick={() => { saveCurrentProject(); setShowMenu(false); }} className="w-full flex items-center gap-2 px-3 py-2 mb-1 bg-green-600 text-white rounded text-sm" type="button">
                    <Save className="w-4 h-4" />Save
                  </button>
                  <button onClick={() => { exportData(); setShowMenu(false); }} className="w-full flex items-center gap-2 px-3 py-2 mb-1 bg-blue-600 text-white rounded text-sm" type="button">
                    <Download className="w-4 h-4" />Export JSON
                  </button>
                  <button onClick={() => { generateReport(); setShowMenu(false); }} className="w-full flex items-center gap-2 px-3 py-2 mb-1 bg-purple-600 text-white rounded text-sm" type="button">
                    <Download className="w-4 h-4" />Export Report
                  </button>
                  <button onClick={() => { importFileRef.current?.click(); setShowMenu(false); }} className="w-full flex items-center gap-2 px-3 py-2 mb-1 bg-orange-600 text-white rounded text-sm" type="button">
                    <Upload className="w-4 h-4" />Import
                  </button>
                </div>
                
                <div className="border-t p-3 text-xs text-gray-500">
                  <p><b>{projects.length}</b> inspection(s) saved</p>
                </div>
              </div>
            </div>
          )}

          {/* Photo Viewer */}
          {photoViewer && (
            <div className="fixed inset-0 z-50 bg-black bg-opacity-90 flex flex-col">
              <div className="flex justify-between items-center p-3 text-white">
                <span className="text-sm">{new Date(photoViewer.photo.timestamp).toLocaleString()}</span>
                <div className="flex gap-3">
                  <button onClick={() => deletePhoto(photoViewer.photoKey, photoViewer.photo.id)} className="p-2 bg-red-600 rounded" type="button">
                    <Trash className="w-5 h-5" />
                  </button>
                  <button onClick={() => setPhotoViewer(null)} className="p-2 bg-gray-700 rounded" type="button">
                    <X className="w-5 h-5" />
                  </button>
                </div>
              </div>
              <div className="flex-1 flex items-center justify-center p-4">
                <img src={photoViewer.photo.data} alt="Inspection" className="max-w-full max-h-full object-contain" />
              </div>
            </div>
          )}

          {/* No Project Selected View */}
          {!currentProject && (
            <div className="flex-1 flex items-center justify-center p-4">
              <div className="text-center">
                <FolderOpen className="w-16 h-16 mx-auto mb-4 text-gray-400" />
                <h2 className="text-xl font-bold text-gray-700 mb-2">No Inspection Selected</h2>
                <p className="text-gray-500 mb-4">Create a new inspection to get started</p>
                <button
                  onClick={() => setShowNewProjectModal(true)}
                  className="px-6 py-3 bg-green-600 text-white rounded-lg font-medium flex items-center gap-2 mx-auto"
                  type="button"
                >
                  <Plus className="w-5 h-5" />
                  New Inspection
                </button>
              </div>
            </div>
          )}

          {/* Main Content - only show if project selected */}
          {currentProject && (
            <>
              {/* Tab Bar */}
              <div className="bg-white border-b overflow-x-auto flex-shrink-0">
                <div className="flex px-2 py-1 gap-1" style={{minWidth: 'max-content'}}>
                  {tabs.map(tab => (
                    <button
                      key={tab.id}
                      onClick={() => setActiveTab(tab.id)}
                      className={`px-3 py-2 rounded text-xs whitespace-nowrap ${activeTab === tab.id ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}
                      type="button"
                    >
                      {tab.name}
                    </button>
                  ))}
                </div>
              </div>

              {/* Content */}
              <div className="flex-1 overflow-y-auto p-3">
                <div className="max-w-2xl mx-auto">
                  {activeTab === 'general' && (
                    <div>
                      <h2 className="text-lg font-bold mb-3">3.1 General</h2>
                      <InspectionField label="Access" section="general" field="access" rows={2} />
                      <InspectionField label="Routine inspection reports" section="general" field="routineReports" rows={2} />
                      <InspectionField label="Emergency Warning" section="general" field="emergencyWarning" rows={2} />
                      <InspectionField label="Illumination" section="general" field="illumination" rows={2} />
                      <InspectionField label="Water level on day of inspection" section="general" field="waterLevel" rows={1} />
                      <InspectionField label="Weather conditions" section="general" field="weatherConditions" rows={2} />
                    </div>
                  )}

                  {activeTab === 'crest' && (
                    <div>
                      <h2 className="text-lg font-bold mb-3">3.2 Non-Overspill Crest</h2>
                      <InspectionField label="Condition of crest" section="crest" field="condition" />
                      <InspectionField label="Vegetation" section="crest" field="vegetation" />
                      <InspectionField label="Animal activity" section="crest" field="animalActivity" rows={2} />
                      <InspectionField label="Settlement" section="crest" field="settlement" />
                    </div>
                  )}

                  {activeTab === 'upstream' && (
                    <div>
                      <h2 className="text-lg font-bold mb-3">3.3 Upstream Face</h2>
                      <InspectionField label="Slope protection" section="upstream" field="slopeProtection" rows={2} />
                      <InspectionField label="Condition of face" section="upstream" field="condition" />
                      <InspectionField label="Vegetation" section="upstream" field="vegetation" />
                      <InspectionField label="Animal burrows" section="upstream" field="animalBurrows" rows={2} />
                    </div>
                  )}

                  {activeTab === 'downstream' && (
                    <div>
                      <h2 className="text-lg font-bold mb-3">3.4 Downstream Face</h2>
                      <InspectionField label="Slope protection" section="downstream" field="slopeProtection" rows={2} />
                      <InspectionField label="Condition of face" section="downstream" field="condition" />
                      <InspectionField label="Vegetation" section="downstream" field="vegetation" />
                      <InspectionField label="Seepage" section="downstream" field="seepage" rows={2} />
                      <InspectionField label="Animal activity" section="downstream" field="animalActivity" rows={2} />
                    </div>
                  )}

                  {activeTab === 'toe' && (
                    <div>
                      <h2 className="text-lg font-bold mb-3">3.5 Downstream Toe</h2>
                      <InspectionField label="Condition" section="toe" field="condition" rows={2} />
                      <InspectionField label="Erosion" section="toe" field="erosion" rows={2} />
                      <InspectionField label="Seepage" section="toe" field="seepage" rows={2} />
                      <InspectionField label="Vegetation" section="toe" field="vegetation" rows={2} />
                      <InspectionField label="Drainage system" section="toe" field="drainageSystem" />
                      <InspectionField label="Valley floor downstream of toe" section="toe" field="valleyFloor" rows={2} />
                    </div>
                  )}

                  {activeTab === 'spillway' && (
                    <div>
                      <h2 className="text-lg font-bold mb-3">3.6 Spillway</h2>
                      <InspectionField label="Description" section="spillway" field="description" />
                      <InspectionField label="Condition" section="spillway" field="condition" rows={4} />
                      <InspectionField label="Vegetation" section="spillway" field="vegetation" />
                      <InspectionField label="Erosion" section="spillway" field="erosion" rows={4} />
                    </div>
                  )}

                  {activeTab === 'outlet' && (
                    <div>
                      <h2 className="text-lg font-bold mb-3">3.7 Outlet Works</h2>
                      <InspectionField label="Description" section="outlet" field="description" rows={4} />
                      <InspectionField label="Operation of valves" section="outlet" field="operation" />
                      <InspectionField label="Condition" section="outlet" field="condition" />
                      <InspectionField label="Access to outlet works" section="outlet" field="access" rows={2} />
                      <InspectionField label="Maintenance and test procedure" section="outlet" field="maintenance" />
                      <InspectionField label="Seepage along outlet pipe" section="outlet" field="seepage" rows={2} />
                    </div>
                  )}

                  {activeTab === 'basin' && (
                    <div>
                      <h2 className="text-lg font-bold mb-3">3.8 Reservoir Basin</h2>
                      <InspectionField label="Condition" section="basin" field="condition" />
                      <InspectionField label="Erosion" section="basin" field="erosion" rows={2} />
                      <InspectionField label="Seepage through basin" section="basin" field="seepage" rows={2} />
                    </div>
                  )}

                  {activeTab === 'monitoring' && (
                    <div>
                      <h2 className="text-lg font-bold mb-3">3.9 Monitoring of Dam</h2>
                      <InspectionField label="Description" section="monitoring" field="description" />
                      <InspectionField label="Settlement monitoring" section="monitoring" field="settlementMonitoring" />
                      <InspectionField label="Seepage monitoring" section="monitoring" field="seepageMonitoring" />
                    </div>
                  )}

                  {activeTab === 'survey' && (
                    <div>
                      <h2 className="text-lg font-bold mb-3">3.9.1 Crest Survey</h2>
                      <p className="text-xs text-gray-600 mb-3">Freeboard auto-calculated from FSL</p>
                      
                      <div className="overflow-x-auto -mx-3 px-3">
                        <table className="w-full border text-sm" style={{minWidth: '450px'}}>
                          <thead className="bg-gray-200">
                            <tr>
                              <th className="border px-2 py-1">Ch (m)</th>
                              <th className="border px-2 py-1">R.L. (m)</th>
                              <th className="border px-2 py-1">FB (m)</th>
                              <th className="border px-2 py-1">Comment</th>
                              <th className="border px-2 py-1 w-8"></th>
                            </tr>
                          </thead>
                          <tbody>
                            {crestSurvey.map((point, index) => (
                              <tr key={index}>
                                <td className="border p-1">
                                  <input 
                                    type="text" 
                                    defaultValue={point.chainage} 
                                    onBlur={(e) => updateSurveyPoint(index, 'chainage', e.target.value)} 
                                    className="w-full px-1 py-1 text-sm border rounded" 
                                    style={{ fontSize: '16px' }}
                                  />
                                </td>
                                <td className="border p-1">
                                  <input 
                                    type="text" 
                                    defaultValue={point.level} 
                                    onBlur={(e) => updateSurveyPoint(index, 'level', e.target.value)} 
                                    className="w-full px-1 py-1 text-sm border rounded" 
                                    style={{ fontSize: '16px' }}
                                  />
                                </td>
                                <td className="border p-1">
                                  <input 
                                    type="text" 
                                    value={point.freeboard} 
                                    readOnly 
                                    className="w-full px-1 py-1 text-sm bg-gray-100 rounded" 
                                  />
                                </td>
                                <td className="border p-1">
                                  <input 
                                    type="text" 
                                    defaultValue={point.comment} 
                                    onBlur={(e) => updateSurveyPoint(index, 'comment', e.target.value)} 
                                    className="w-full px-1 py-1 text-sm border rounded" 
                                    style={{ fontSize: '16px' }}
                                  />
                                </td>
                                <td className="border p-1 text-center">
                                  {index > 0 && <button onClick={() => removeSurveyPoint(index)} className="text-red-600 font-bold" type="button">Ã—</button>}
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                      
                      <button onClick={addSurveyPoint} className="mt-3 px-4 py-2 bg-blue-600 text-white rounded text-sm" type="button">
                        + Add Point
                      </button>
                    </div>
                  )}
                </div>
              </div>

              {/* Bottom Bar */}
              <div className="bg-white border-t p-2 flex gap-2 flex-shrink-0">
                <button onClick={saveCurrentProject} className="flex-1 py-3 bg-green-600 text-white rounded-lg font-medium flex items-center justify-center gap-2" type="button">
                  <Save className="w-5 h-5" />Save
                </button>
                <button onClick={exportData} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-medium flex items-center justify-center gap-2" type="button">
                  <Download className="w-5 h-5" />Export
                </button>
              </div>
            </>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<Section3Inspection />);
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('SW registered'))
          .catch(err => console.log('SW failed:', err));
      });
    }
  </script>
</body>
</html>
